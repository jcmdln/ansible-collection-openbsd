---
# site.yml

- name: Check
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [always, check]
  tasks:
    - name: Confirm host is running OpenBSD
      raw: >-
        uname
      changed_when: false
      failed_when: ("OpenBSD" not in uname.stdout)
      register: uname

    - name: Check if Python 3.x is present
      raw: >-
        command -v python3
      changed_when: not python
      failed_when: false
      register: python

    - name: Install Python 3.x if missing
      raw: >-
        pkg_add python3
      when:
        - python.rc is defined
        - python.rc > 0

    - name: Gather facts
      setup:

- name: Update
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [never, update]
  roles:
    - role: openbsd.syspatch
      tags: [syspatch]

    - role: openbsd.sysupgrade
      tags: [sysupgrade]

- name: Base
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [base]
  roles:
    - role: openbsd.doas
      tags: [doas]

    - role: openbsd.ntpd
      tags: [ntpd]

    - role: openbsd.pf
      tags: [pf]

- name: DNS
  any_errors_fatal: true
  gather_facts: false
  hosts: dns
  tags: [never, dns]
  roles:
    - role: openbsd.nsd
      tags: [nsd]

    - role: openbsd.unwind
      tags: [unwind]

# - name: Firewall
#   any_errors_fatal: true
#   gather_facts: false
#   hosts: firewall
#   tags: [never, firewall]

- name: Mail
  any_errors_fatal: true
  gather_facts: false
  hosts: mail
  tags: [never, mail]
  roles:
    - role: openbsd.mail

- name: Web
  any_errors_fatal: true
  gather_facts: false
  hosts: web
  tags: [never, web]
  roles:
    - role: openbsd.httpd
      tags: [httpd]

- name: Acme
  any_errors_fatal: true
  gather_facts: false
  hosts: acme
  tags: [never, acme]
  roles:
    - role: openbsd.acme
      tags: [acme]
