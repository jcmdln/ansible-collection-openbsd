---
# site.yml

#
# Check
#

- name: Check
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [always]

  pre_tasks:
    - name: Confirm host is running OpenBSD
      raw: >-
        uname
      changed_when: false
      failed_when: ("OpenBSD" not in uname.stdout)
      register: uname

    - name: Check if Python 3.x is present
      raw: >-
        command -v python3
      changed_when: not python
      register: python

    - name: Install Python 3.x if missing
      raw: >-
        pkg_add python3
      when: not python

  tasks:
    - name: Gather facts
      setup:

#
# Update
#

- name: Update
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [never, update]

  roles:
    - role: openbsd.syspatch
      tags: [update-syspatch]

    - role: openbsd.sysupgrade
      tags: [update-sysupgrade]

#
# Setup
#

- name: Setup
  any_errors_fatal: true
  gather_facts: false
  hosts: all
  tags: [setup]

  roles:
    - role: openbsd.doas
      tags: [setup-doas]

    - role: openbsd.ntpd
      tags: [setup-ntpd]

    - role: openbsd.unwind
      tags: [setup-unwind]

#
# DNS
#

- name: DNS
  any_errors_fatal: true
  gather_facts: false
  hosts: dns
  tags: [never, dns]

  roles:
    - role: openbsd.nsd
      tags: [dns-nsd]

#
# Mail
#

- name: Setup mail servers
  any_errors_fatal: true
  gather_facts: false
  hosts: mail
  tags: [never, mail]

  roles:
    - role: openbsd.mail
