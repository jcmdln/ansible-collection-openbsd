# openbsd.sysupgrade/tasks/main.yml

- name: upgrade to latest release or snapshot
  sysupgrade:
    branch: "{{ sysupgrade_branch }}"
  register: sysupgrade_result
  when:
    - ansible_distribution_version is version("6.6", ">=")

- name: reboot if upgraded
  reboot:
    connect_timeout: "{{ connect_timeout }}"
    reboot_timeout: "{{ reboot_timeout }}"
  when:
    - sysupgrade_result.changed

- name: (release) update packages
  command: >-
    pkg_add -u
  when:
    - sysupgrade_result.changed
    - ansible_distribution_release not in ["current", "beta"]

- name: (current) reinstall snapshot packages
  command: >-
    pkg_add -ruD snap
  when:
    - sysupgrade_result.changed
    - ansible_distribution_release in ["current", "beta"]
